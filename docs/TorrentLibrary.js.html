<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TorrentLibrary.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="TorrentLibrary.html">TorrentLibrary</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TorrentLibrary.html#.listVideosExtension">listVideosExtension</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TorrentLibrary.html#addNewPath">addNewPath</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TorrentLibrary.html#hasPathsProvidedByUser">hasPathsProvidedByUser</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TorrentLibrary.html#scan">scan</a></span></li><li class="nav-heading">Externals</li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-access.html">access</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-difference.html">difference</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-FileHound.html">FileHound</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-nameParser.html">nameParser</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-Promise.html">Promise</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-uniq.html">uniq</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-videosExtension.html">videosExtension</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li>
</nav>

<div id="main">
    
    <h1 class="page-title">TorrentLibrary.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// JSDoc custom typedef
/**
 * The result of parsing file name
 * @typedef {Object} TPN
 * @see {@link https://github.com/jy95/torrent-name-parser}
 * @property {(string)} title - The file title
 * @property {(number|undefined)} season - The season number
 * @property {(number|undefined)} episode - The episode number
 * @property {(string|undefined)} episodeName - The episode name
 * @property {(number|undefined)} year - The year
 * @property {(string|undefined)} resolution - The resolution
 * @property {(string|undefined)} quality - The quality
 * @property {(string|undefined)} codec - The codec
 * @property {(string|undefined)} audio - The audio
 * @property {(string|undefined)} group - The group that releases this file
 * @property {(string|undefined)} region - The quality
 * @property {(string|undefined)} extended - extended ?
 * @property {(string|undefined)} hardcoded - hardcoded ?
 * @property {(string|undefined)} proper - proper ?
 * @property {(string|undefined)} repack - repack ?
 * @property {(string|undefined)} container - The container
 * @property {(string|undefined)} website - The website that releases this file
 * @property {(string|undefined)} language - The file language
 * @property {(string|undefined)} excess - Unmatched text from filename
 */

/**
 * The extended TPN object
 * @typedef {TPN} TPN_Extended
 * @property {string} filePath - additionnal property useful for this library
 */

/**
 * The variable where we store all kind of media files found in paths
 * @typedef {Map.&lt;string, {( Set&lt;TPN_Extended>| Map.&lt;string,Set&lt;TPN_Extended>> )}>} StoreVar
 * @example
 * // An example of the variable after the scan method
 * [
 *      "MOVIES" : [
 *         {
 *            "year": 2014,
 *            "resolution": '1080p',
 *            "quality": 'BrRip',
 *            "codec": 'x264',
 *            "container": 'MKV',
 *            "title": 'Captain Russia The Summer Soldier',
 *            "filePath": "D:\somePath\Captain Russia The Summer Soldier (2014) 1080p BrRip x264.MKV"
 *         }
 *      ],
 *      "TV_SERIES" : [
 *          "The Blacklist" : [
 *              {
 *                  "season": 4,
 *                  "episode": 21,
 *                  "quality": "WEBRip",
 *                  "codec": "XviD",
 *                  "container": "avi",
 *                  "language": "FRENCH"
 *                  "filePath" : "D:\somePath\The.Blacklist.S04E21.FRENCH.WEBRip.XviD.avi"
 *              }
 *          ]
 *      ]
 * ]
 */


/**
 * module for exploring directories
 * @external FileHound
 * @see {@link https://nspragg.github.io/filehound/}
 */
import FileHound from 'filehound';

/**
 * Access method from module fs (node)
 * @external access
 * @see {@link https://nodejs.org/api/fs.html#fs_fs_access_path_mode_callback}
 */
import {access} from 'fs';

/**
 * uniq method from Lodash
 * @external uniq
 * @see {@link https://lodash.com/docs/4.17.4#uniq}
 */
import {uniq} from 'lodash';
/**
 * difference method from lodash
 * @external difference
 * @see {@link https://lodash.com/docs/4.17.4#difference}
 */
import {difference} from 'lodash';

/**
 * A promise object provided by the bluebird promise library.
 * @external Promise
 * @see {@link http://bluebirdjs.com/docs/api-reference.html}
 */
import PromiseLib from 'bluebird'

/**
 * List of video file extensions
 * @external videosExtension
 * @see {@link https://github.com/sindresorhus/video-extensions}
 */
import videosExtension from 'video-extensions';

/**
 * Parser for media files name
 * @external nameParser
 * @see {@link https://github.com/jy95/torrent-name-parser}
 */
import nameParser from 'torrent-name-parser'

/**
 * Constants for fs access
 */
import {
    constants as FsConstants
} from 'fs'

import {
    EventEmitter
} from 'events';

/**
 * Class representing the TorrentLibrary
 * @extends EventEmitter
 * @see {@link https://nodejs.org/api/events.html#events_class_eventemitter } for further information.
 */
class TorrentLibrary extends EventEmitter {

    /**
     * constant for movie category
     * @since 0.0.0
     * @return {string}
     */
    static get MOVIES_TYPE() {
        return "MOVIES"
    }

    /**
     * constant for tv series category
     * @return {string}
     */
    static get TV_SERIES_TYPE() {
        return "TV_SERIES"
    }

    /**
     * Create a TorrentLibrary
     */
    constructor() {
        super();
        /**
         * just an easy way to scan the current directory path, if not other paths provided
         * @member  {string}
         * @default the directory from which you invoked the node command
         */
        this.defaultPath = process.cwd();
        /**
         * the paths where we are looking the media files
         * @member {String[]}
         * @default []
         * @example
         * // after have added some paths ...
         * [ "D:\somePath", "D:\anotherPath" ]
         */
        this.paths = [];
        /**
         * The variable where we store all kind of media files found in paths
         * @member {StoreVar}
         */
        this.stores = new Map([
            [TorrentLibrary.MOVIES_TYPE, new Set()],
            [TorrentLibrary.TV_SERIES_TYPE, new Map()]
        ]);
        /**
         * Mapping filepath => category
         * @type {Map}
         * @example
         * { "D:\somePath\Captain Russia The Summer Soldier (2014) 1080p BrRip x264.MKV" => TorrentLibrary.MOVIES_TYPE }
         */
        this.categoryForFile = new Map();
        /**
         * Private method for adding new files
         * @private
         * @param files {string[]} An array of filePath
         */
        this.addNewFiles = function (files) {

            // find the new files to be added
            let alreadyFoundFiles = [...this.categoryForFile.keys()];
            let newFiles = difference(files, alreadyFoundFiles);

            // temp var for new files before adding them to stores var
            let moviesSet = new Set();
            let tvSeriesSet = new Set();

            // get previous result of stores var
            let newMovies = this.stores.get(TorrentLibrary.MOVIES_TYPE);
            let newTvSeries = this.stores.get(TorrentLibrary.TV_SERIES_TYPE);

            // process each file
            for (let file of newFiles) {
                // get data from nameParser lib
                let jsonFile = nameParser(file);
                // extend this object in order to be used by this library
                Object.assign(jsonFile, {"filePath": file});
                // find out which type of this file
                // if it has not undefined properties (season and episode) => TV_SERIES , otherwise MOVIE
                let fileCategory = ( checkProperties(jsonFile, ["season", "episode"]) )
                    ? TorrentLibrary.TV_SERIES_TYPE : TorrentLibrary.MOVIES_TYPE;
                // add it in found files
                this.categoryForFile.set(file, fileCategory);
                // also in temp var
                (fileCategory === TorrentLibrary.TV_SERIES_TYPE) ? tvSeriesSet.add(jsonFile) : moviesSet.add(jsonFile);
            }

            // add the movies into newMovies
            newMovies = new Set([...newMovies, ...moviesSet]);

            // add the tv series into newTvSeries
            // First step : find all the series not in newTvSeries and add them to newTvSeries
            difference(
                uniq(
                    [...tvSeriesSet].map(function (tvSeries) {
                        return tvSeries.title;
                    })
                ),
                ...newTvSeries.keys()
            ).forEach(function (tvSeriesToInsert) {
                newTvSeries.set(tvSeriesToInsert, new Set());
            });

            // Second step : add the new files into the correct tvSeries Set
            uniq(
                [...tvSeriesSet].map(function (tvSeries) {
                    return tvSeries.title;
                })
            ).forEach(function (tvSerie) {

                // get the current set for this tvSerie
                let currentTvSerie = newTvSeries.get(tvSerie);

                // find all the episodes in the new one for this serie
                let episodes = [...tvSeriesSet].filter(function (episode) {
                    return episode.title === tvSerie;
                });

                // add them and updates newTvSeries
                newTvSeries.set(tvSerie, new Set([...currentTvSerie,...episodes]));

            });

            // updates the stores var
            this.stores.set(TorrentLibrary.MOVIES_TYPE, newMovies);
            this.stores.set(TorrentLibrary.TV_SERIES_TYPE, newTvSeries);

        }
    }

    /**
     * Provides the array of files extensions considered to be media extensions
     * @return {string[]} array of files extensions
     * @since 0.0.0
     * @example
     * // Returns [..., 'webm', 'wmv']
     * TorrentLibrary.listVideosExtension()
     * @static
     */
    static listVideosExtension() {
        return videosExtension;
    }

    /**
     * Add the path(s) to be analyzed by the library if they exist and are readable
     * @param {(string|string[])} paths - A path or an array of paths
     * @since 0.0.0
     * @example
     * // return resolved Promise "All paths were added!"
     * TorrentLibraryInstance.addNewPath("C:\Users\jy95\Desktop\New folder");
     * @return {external:Promise}  On success the promise will be resolved with "All paths were added!"&lt;br>
     * On error the promise will be rejected with an Error object "Missing parameter" if the argument is missing&lt;br>
     * or an Error object from fs &lt;br>
     */
    addNewPath(...paths) {
        // the user should provide us at lest a path
        if (paths.length === 0)
            return missingParam();

        let that = this;
        return new PromiseLib(function (resolve, reject) {

            PromiseLib.map(paths, function (path) {
                return access(path, FsConstants.F_OK | FsConstants.R_OK);
            }).then(function () {
                // keep only unique paths
                that.paths = uniq([...that.paths, ...paths]);
                resolve("All paths were added!");
            }).catch(e => {
                reject(e);
            })

        });

    }

    /**
     * Tell us if the user has provided us paths
     * @since 0.0.0
     * @returns {boolean}
     */
    hasPathsProvidedByUser() {
        return this.paths.length === 0;
    }

    /**
     * @todo Write the documentation.
     * @todo Implement this function.
     */
    scan() {

        const foundFiles = FileHound.create()
            .paths((this.paths.length === 0) ? this.defaultPath : this.paths)
            .ext(videosExtension)
            .find();
        let that = this;

        return new PromiseLib(function (resolve, reject) {
            foundFiles
                .then(function (files) {
                    that.addNewFiles(files);
                    resolve("Scanning completed");
                })
                .catch(function (err) {
                    reject(err);
                });
        });
    }

}

// rejected promise when someone doesn't provide
function missingParam() {
    return new PromiseLib(function (resolve, reject) {
        reject(new Error("Missing parameter"));
    });
}

// check if an object has these properties and they are not undefined
function checkProperties(obj, properties) {
    return properties.every(function (x) {
        return x in obj &amp;&amp; obj[x];
    })
}

export default TorrentLibrary;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Sat Aug 26 2017 19:02:13 GMT+0200 (Romance Daylight Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
